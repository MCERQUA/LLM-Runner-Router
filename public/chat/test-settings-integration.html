<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings Integration Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #007acc;
            padding-bottom: 10px;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #005a9e;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .config-display {
            background: #2a2a2a;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üß™ Settings Integration Test Suite</h1>
    
    <div class="test-section">
        <h2>1. Configuration Loading</h2>
        <button onclick="testConfigLoading()">Test Config Loading</button>
        <button onclick="showCurrentConfig()">Show Current Config</button>
        <div id="configLoadResult"></div>
    </div>

    <div class="test-section">
        <h2>2. System Prompt Test</h2>
        <button onclick="testSystemPrompt()">Test System Prompt</button>
        <div id="systemPromptResult"></div>
    </div>

    <div class="test-section">
        <h2>3. Parameter Application</h2>
        <button onclick="testParameters()">Test Parameters</button>
        <div id="parametersResult"></div>
    </div>

    <div class="test-section">
        <h2>4. Template Settings</h2>
        <button onclick="testTemplates()">Test Templates</button>
        <div id="templatesResult"></div>
    </div>

    <div class="test-section">
        <h2>5. Live Inference Test</h2>
        <input type="text" id="testPrompt" placeholder="Enter test prompt" style="width: 300px; padding: 8px;">
        <button onclick="testInference()">Test Inference</button>
        <div id="inferenceResult"></div>
    </div>

    <div class="test-section">
        <h2>6. Settings Synchronization</h2>
        <button onclick="testSync()">Test Admin Panel Sync</button>
        <div id="syncResult"></div>
    </div>

    <script src="/chat/config-manager.js"></script>
    <script>
        const configManager = new ConfigManager();
        const apiUrl = window.location.origin;
        
        function addResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = message;
            element.appendChild(div);
        }
        
        async function testConfigLoading() {
            const resultDiv = document.getElementById('configLoadResult');
            resultDiv.innerHTML = '';
            
            try {
                await configManager.loadConfig();
                addResult('configLoadResult', '‚úÖ Configuration loaded successfully', 'success');
                
                const config = configManager.config;
                if (config) {
                    addResult('configLoadResult', `Active Model: ${config.activeModel || 'auto'}`, 'info');
                    addResult('configLoadResult', `Routing Strategy: ${config.routingStrategy || 'balanced'}`, 'info');
                    addResult('configLoadResult', `System Prompt Enabled: ${config.behavior?.useSystemPrompt !== false}`, 'info');
                }
            } catch (error) {
                addResult('configLoadResult', `‚ùå Failed to load config: ${error.message}`, 'error');
            }
        }
        
        async function showCurrentConfig() {
            const resultDiv = document.getElementById('configLoadResult');
            resultDiv.innerHTML = '';
            
            await configManager.loadConfig();
            const config = configManager.config;
            
            const configHtml = `<div class="config-display"><pre>${JSON.stringify(config, null, 2)}</pre></div>`;
            addResult('configLoadResult', configHtml, 'info');
        }
        
        async function testSystemPrompt() {
            const resultDiv = document.getElementById('systemPromptResult');
            resultDiv.innerHTML = '';
            
            await configManager.loadConfig();
            
            const systemPrompt = configManager.getSystemPrompt();
            const isEnabled = configManager.isSystemPromptEnabled();
            
            addResult('systemPromptResult', `System Prompt Enabled: ${isEnabled}`, isEnabled ? 'success' : 'info');
            
            if (systemPrompt) {
                addResult('systemPromptResult', `System Prompt: "${systemPrompt.substring(0, 100)}${systemPrompt.length > 100 ? '...' : ''}"`, 'info');
            } else {
                addResult('systemPromptResult', 'No system prompt configured', 'info');
            }
            
            // Test formatting
            const testMessages = [
                { role: 'user', content: 'Hello' },
                { role: 'assistant', content: 'Hi there!' }
            ];
            
            const formatted = configManager.formatMessages(testMessages);
            addResult('systemPromptResult', `<pre>Formatted with template:\n${formatted}</pre>`, 'info');
        }
        
        async function testParameters() {
            const resultDiv = document.getElementById('parametersResult');
            resultDiv.innerHTML = '';
            
            await configManager.loadConfig();
            const params = configManager.getGenerationParams();
            
            addResult('parametersResult', '‚úÖ Generation Parameters:', 'success');
            addResult('parametersResult', `<pre>${JSON.stringify(params, null, 2)}</pre>`, 'info');
            
            // Check specific values
            const checks = [
                { name: 'Temperature', value: params.temperature, expected: [0, 2] },
                { name: 'Max Tokens', value: params.maxTokens, expected: [1, 4096] },
                { name: 'Top P', value: params.topP, expected: [0, 1] },
                { name: 'Top K', value: params.topK, expected: [1, 100] }
            ];
            
            checks.forEach(check => {
                const inRange = check.value >= check.expected[0] && check.value <= check.expected[1];
                addResult('parametersResult', 
                    `${check.name}: ${check.value} ${inRange ? '‚úÖ' : '‚ö†Ô∏è'} (range: ${check.expected[0]}-${check.expected[1]})`,
                    inRange ? 'success' : 'error'
                );
            });
        }
        
        async function testTemplates() {
            const resultDiv = document.getElementById('templatesResult');
            resultDiv.innerHTML = '';
            
            await configManager.loadConfig();
            const template = configManager.getTemplateSettings();
            
            addResult('templatesResult', '‚úÖ Template Settings:', 'success');
            addResult('templatesResult', `<pre>${JSON.stringify(template, null, 2)}</pre>`, 'info');
            
            // Test template application
            const testPrompt = 'Test message';
            const systemPrompt = configManager.getSystemPrompt();
            
            if (systemPrompt && configManager.isSystemPromptEnabled()) {
                const formatted = `${template.systemPrefix} ${systemPrompt}${template.separator}${template.userPrefix} ${testPrompt}`;
                addResult('templatesResult', `Sample formatted prompt:\n<pre>${formatted}</pre>`, 'info');
            }
        }
        
        async function testInference() {
            const resultDiv = document.getElementById('inferenceResult');
            resultDiv.innerHTML = '';
            
            const prompt = document.getElementById('testPrompt').value || 'Hello, how are you?';
            
            await configManager.loadConfig();
            const params = configManager.getGenerationParams();
            const systemPrompt = configManager.getSystemPrompt();
            const template = configManager.getTemplateSettings();
            
            // Build request as chat would
            let fullPrompt = prompt;
            if (configManager.isSystemPromptEnabled() && systemPrompt) {
                fullPrompt = `${template.systemPrefix} ${systemPrompt}${template.separator}${template.userPrefix} ${prompt}`;
            }
            
            addResult('inferenceResult', 'Sending inference request...', 'info');
            
            try {
                const response = await fetch(`${apiUrl}/api/inference`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: fullPrompt,
                        temperature: params.temperature,
                        maxTokens: params.maxTokens,
                        topP: params.topP,
                        topK: params.topK,
                        model: configManager.getActiveModel(),
                        strategy: configManager.getRoutingStrategy()
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    addResult('inferenceResult', '‚úÖ Inference successful!', 'success');
                    addResult('inferenceResult', `Response: ${result.response || result.text}`, 'info');
                    addResult('inferenceResult', `Model used: ${result.model}`, 'info');
                    addResult('inferenceResult', `Processing time: ${result.processingTime}ms`, 'info');
                } else {
                    addResult('inferenceResult', `‚ùå Inference failed: ${result.error}`, 'error');
                }
            } catch (error) {
                addResult('inferenceResult', `‚ùå Request failed: ${error.message}`, 'error');
            }
        }
        
        async function testSync() {
            const resultDiv = document.getElementById('syncResult');
            resultDiv.innerHTML = '';
            
            // Test saving config to server
            addResult('syncResult', 'Testing configuration sync...', 'info');
            
            const testConfig = {
                activeModel: 'test-model',
                systemPrompt: 'Test system prompt from integration test',
                parameters: {
                    temperature: 0.8,
                    maxTokens: 200
                }
            };
            
            try {
                // Save to server
                const saveResponse = await fetch(`${apiUrl}/api/config`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testConfig)
                });
                
                if (saveResponse.ok) {
                    addResult('syncResult', '‚úÖ Config saved to server', 'success');
                }
                
                // Try to load from server
                const loadResponse = await fetch(`${apiUrl}/api/config`);
                const serverConfig = await loadResponse.json();
                
                addResult('syncResult', `Server config response: <pre>${JSON.stringify(serverConfig, null, 2)}</pre>`, 'info');
                
                // Test localStorage sync
                const savedLocal = localStorage.getItem('llmRouterConfig');
                if (savedLocal) {
                    addResult('syncResult', '‚úÖ Config found in localStorage', 'success');
                    const localConfig = JSON.parse(savedLocal);
                    addResult('syncResult', `Active model in localStorage: ${localConfig.activeModel}`, 'info');
                }
                
            } catch (error) {
                addResult('syncResult', `‚ùå Sync test failed: ${error.message}`, 'error');
            }
        }
        
        // Auto-run basic test on load
        window.addEventListener('load', () => {
            testConfigLoading();
        });
    </script>
</body>
</html>