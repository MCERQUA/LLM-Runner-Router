<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel Template Integration Test</title>
    <style>
        body {
            font-family: monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            line-height: 1.6;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            background: #2a2a2a;
        }
        .pass { border-left: 4px solid #4ec9b0; }
        .fail { border-left: 4px solid #f48771; }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #005a9e; }
        pre {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üß™ Admin Panel Template Integration Test</h1>
    
    <div>
        <button onclick="runTests()">Run All Tests</button>
        <button onclick="clearResults()">Clear Results</button>
    </div>
    
    <div id="results"></div>

    <script src="/chat/model-templates.js"></script>
    <script>
        const resultsDiv = document.getElementById('results');
        
        function log(message, isPass = true) {
            const div = document.createElement('div');
            div.className = `test-result ${isPass ? 'pass' : 'fail'}`;
            div.innerHTML = message;
            resultsDiv.appendChild(div);
        }
        
        function clearResults() {
            resultsDiv.innerHTML = '';
        }
        
        async function runTests() {
            clearResults();
            log('<h2>Starting Template Integration Tests...</h2>');
            
            // Test 1: Check if ModelTemplates is loaded
            try {
                if (window.ModelTemplates) {
                    log('‚úÖ Test 1: ModelTemplates is loaded');
                } else {
                    throw new Error('ModelTemplates not found');
                }
            } catch (e) {
                log('‚ùå Test 1: ModelTemplates failed to load: ' + e.message, false);
            }
            
            // Test 2: Test template detection for various models
            const testModels = [
                { id: 'tinyllama-1.1b-chat', expected: 'TinyLlama' },
                { id: 'phi-2', expected: 'Phi' },
                { id: 'mistral-7b-instruct', expected: 'Mistral' },
                { id: 'llama-2-7b-chat', expected: 'Llama 2' }
            ];
            
            log('<h3>Testing Model Template Detection:</h3>');
            
            testModels.forEach(test => {
                const template = window.ModelTemplates.getTemplateForModel(test.id);
                const templateId = window.ModelTemplates.getTemplateIdForModel(test.id);
                
                if (template.name === test.expected) {
                    log(`‚úÖ ${test.id} ‚Üí ${template.name} (ID: ${templateId})`);
                } else {
                    log(`‚ùå ${test.id} ‚Üí Expected ${test.expected}, got ${template.name}`, false);
                }
            });
            
            // Test 3: Check getAllTemplates function
            try {
                const allTemplates = window.ModelTemplates.getAllTemplates();
                log(`<h3>Available Templates (${allTemplates.length}):</h3>`);
                
                const templateList = allTemplates.map(t => 
                    `‚Ä¢ ${t.name} (${t.id})`
                ).join('<br>');
                
                log(templateList);
            } catch (e) {
                log('‚ùå Failed to get all templates: ' + e.message, false);
            }
            
            // Test 4: Test template content
            log('<h3>Testing Template Content:</h3>');
            
            const tinyllamaTemplate = window.ModelTemplates.templates.tinyllama;
            if (tinyllamaTemplate) {
                log(`‚úÖ TinyLlama Template Found:<br><pre>${JSON.stringify(tinyllamaTemplate, null, 2)}</pre>`);
            } else {
                log('‚ùå TinyLlama template not found', false);
            }
            
            // Test 5: Simulate model selection and template auto-selection
            log('<h3>Testing Auto-Selection Logic:</h3>');
            
            const simulatedModels = [
                'tinyllama-1.1b-chat-v1.0.Q4_K_M',
                'phi-2.Q4_K_M',
                'unknown-model-xyz'
            ];
            
            simulatedModels.forEach(modelId => {
                const template = window.ModelTemplates.getTemplateForModel(modelId);
                const templateId = window.ModelTemplates.getTemplateIdForModel(modelId);
                
                log(`Model: <code>${modelId}</code><br>` +
                    `Selected Template: <strong>${template.name}</strong> (${templateId})<br>` +
                    `User Prefix: <code>${template.userPrefix.replace(/\n/g, '\\n')}</code><br>` +
                    `Assistant Prefix: <code>${template.assistantPrefix.replace(/\n/g, '\\n')}</code>`);
            });
            
            // Test 6: Verify localStorage integration
            log('<h3>Testing Configuration Persistence:</h3>');
            
            // Simulate saving a config
            const testConfig = {
                activeModel: 'tinyllama-1.1b-chat',
                activeTemplate: 'tinyllama',
                templateSettings: window.ModelTemplates.templates.tinyllama
            };
            
            localStorage.setItem('llmRouterConfig_test', JSON.stringify(testConfig));
            
            // Try to retrieve it
            const savedConfig = JSON.parse(localStorage.getItem('llmRouterConfig_test'));
            
            if (savedConfig && savedConfig.activeTemplate === 'tinyllama') {
                log('‚úÖ Configuration persistence working');
                log(`<pre>${JSON.stringify(savedConfig, null, 2)}</pre>`);
            } else {
                log('‚ùå Configuration persistence failed', false);
            }
            
            // Clean up test data
            localStorage.removeItem('llmRouterConfig_test');
            
            log('<h2>‚úÖ All tests completed!</h2>');
        }
    </script>
</body>
</html>