<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: loaders/BitNetLoader.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: loaders/BitNetLoader.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * BitNet Model Loader for 1-bit LLMs
 * Supports Microsoft BitNet models with GGUF format
 */

import { spawn } from 'child_process';
import path from 'path';
import fs from 'fs/promises';
import { fileURLToPath } from 'url';
import BaseLoader from './BaseLoader.js';
import ModelError from '../utils/ModelError.js';
import Logger from '../utils/Logger.js';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const logger = new Logger('BitNetLoader');

/**
 * Loader for BitNet 1-bit quantized models
 * Requires BitNet.cpp to be installed and built
 */
class BitNetLoader extends BaseLoader {
    constructor(config = {}) {
        super(config);
        this.bitnetPath = config.bitnetPath || path.join(__dirname, '../../temp/bitnet-repo');
        this.buildDir = path.join(this.bitnetPath, 'build');
        this.modelDir = path.join(this.bitnetPath, 'models');
        this.supportedFormats = ['.gguf'];
        this.supportedQuantTypes = ['i2_s', 'tl1', 'tl2'];
        this.process = null;
        this.isReady = false;
    }

    /**
     * Check if BitNet.cpp is installed and built
     */
    async checkBitNetInstallation() {
        try {
            // Check if build directory exists
            await fs.access(this.buildDir);
            
            // Check for llama-cli executable
            const cliPath = this.getCliPath();
            await fs.access(cliPath);
            
            return true;
        } catch (error) {
            logger.warn('BitNet.cpp not found or not built');
            return false;
        }
    }

    /**
     * Get the path to llama-cli executable
     */
    getCliPath() {
        const platform = process.platform;
        if (platform === 'win32') {
            const releasePath = path.join(this.buildDir, 'bin', 'Release', 'llama-cli.exe');
            const debugPath = path.join(this.buildDir, 'bin', 'llama-cli.exe');
            
            try {
                fs.accessSync(releasePath);
                return releasePath;
            } catch {
                return debugPath;
            }
        } else {
            return path.join(this.buildDir, 'bin', 'llama-cli');
        }
    }

    /**
     * Build BitNet.cpp if not already built
     */
    async buildBitNet() {
        logger.info('Building BitNet.cpp...');
        
        return new Promise((resolve, reject) => {
            const setupScript = path.join(this.bitnetPath, 'setup_env.py');
            const buildProcess = spawn('python3', [
                setupScript,
                '--build'
            ], {
                cwd: this.bitnetPath,
                stdio: 'inherit'
            });

            buildProcess.on('close', (code) => {
                if (code === 0) {
                    logger.info('BitNet.cpp built successfully');
                    resolve();
                } else {
                    reject(new Error(`BitNet build failed with code ${code}`));
                }
            });

            buildProcess.on('error', (err) => {
                reject(new Error(`Failed to start BitNet build: ${err.message}`));
            });
        });
    }

    /**
     * Download a BitNet model from HuggingFace
     */
    async downloadModel(modelId, quantType = 'i2_s') {
        logger.info(`Downloading BitNet model: ${modelId}`);
        
        const modelName = modelId.split('/').pop();
        const modelPath = path.join(this.modelDir, modelName);
        
        return new Promise((resolve, reject) => {
            const setupScript = path.join(this.bitnetPath, 'setup_env.py');
            const downloadProcess = spawn('python3', [
                setupScript,
                '--hf-repo', modelId,
                '--quant-type', quantType
            ], {
                cwd: this.bitnetPath,
                stdio: 'inherit'
            });

            downloadProcess.on('close', (code) => {
                if (code === 0) {
                    logger.info(`Model ${modelId} downloaded successfully`);
                    resolve(path.join(modelPath, `ggml-model-${quantType}.gguf`));
                } else {
                    reject(new Error(`Model download failed with code ${code}`));
                }
            });

            downloadProcess.on('error', (err) => {
                reject(new Error(`Failed to download model: ${err.message}`));
            });
        });
    }

    /**
     * Convert a safetensors model to GGUF format
     */
    async convertModel(modelPath, outputPath, quantType = 'i2_s') {
        logger.info(`Converting model to GGUF format: ${modelPath}`);
        
        return new Promise((resolve, reject) => {
            const convertScript = path.join(this.bitnetPath, 'utils', 'convert-hf-to-gguf-bitnet.py');
            const convertProcess = spawn('python3', [
                convertScript,
                modelPath,
                '--outtype', quantType,
                '--outfile', outputPath
            ], {
                cwd: this.bitnetPath,
                stdio: 'inherit'
            });

            convertProcess.on('close', (code) => {
                if (code === 0) {
                    logger.info('Model converted successfully');
                    resolve(outputPath);
                } else {
                    reject(new Error(`Model conversion failed with code ${code}`));
                }
            });

            convertProcess.on('error', (err) => {
                reject(new Error(`Failed to convert model: ${err.message}`));
            });
        });
    }

    /**
     * Load a BitNet model
     */
    async load(source, options = {}) {
        try {
            logger.info(`Loading BitNet model from: ${source}`);

            // Check if BitNet is installed
            const isInstalled = await this.checkBitNetInstallation();
            if (!isInstalled) {
                if (options.autoBuild !== false) {
                    await this.buildBitNet();
                } else {
                    throw new ModelError('BitNet.cpp not installed. Run build first or set autoBuild: true');
                }
            }

            let modelPath = source;

            // Handle HuggingFace model IDs
            if (source.includes('/') &amp;&amp; !source.startsWith('/') &amp;&amp; !source.startsWith('.')) {
                const quantType = options.quantType || 'i2_s';
                modelPath = await this.downloadModel(source, quantType);
            }

            // Check if model file exists
            await fs.access(modelPath);

            // Store model configuration
            this.modelConfig = {
                path: modelPath,
                threads: options.threads || 2,
                contextSize: options.contextSize || 2048,
                temperature: options.temperature || 0.8,
                gpuLayers: options.gpuLayers || 0,
                ...options
            };

            this.isReady = true;
            logger.info('BitNet model loaded successfully');

            return {
                type: 'bitnet',
                path: modelPath,
                config: this.modelConfig
            };
        } catch (error) {
            throw new ModelError(`Failed to load BitNet model: ${error.message}`);
        }
    }

    /**
     * Run inference with the loaded model
     */
    async generate(prompt, options = {}) {
        if (!this.isReady) {
            throw new ModelError('Model not loaded. Call load() first.');
        }

        const config = { ...this.modelConfig, ...options };
        const cliPath = this.getCliPath();

        return new Promise((resolve, reject) => {
            const args = [
                '-m', config.path,
                '-p', prompt,
                '-n', String(config.maxTokens || 128),
                '-t', String(config.threads),
                '-c', String(config.contextSize),
                '--temp', String(config.temperature),
                '-ngl', String(config.gpuLayers),
                '-b', '1'
            ];

            if (config.conversation) {
                args.push('-cnv');
            }

            const inferenceProcess = spawn(cliPath, args);
            
            let output = '';
            let error = '';

            inferenceProcess.stdout.on('data', (data) => {
                output += data.toString();
            });

            inferenceProcess.stderr.on('data', (data) => {
                error += data.toString();
            });

            inferenceProcess.on('close', (code) => {
                if (code === 0) {
                    // Parse the output to extract the generated text
                    const generatedText = this.parseOutput(output);
                    resolve({
                        text: generatedText,
                        raw: output,
                        model: 'bitnet',
                        config
                    });
                } else {
                    reject(new ModelError(`Inference failed: ${error}`));
                }
            });

            inferenceProcess.on('error', (err) => {
                reject(new ModelError(`Failed to run inference: ${err.message}`));
            });
        });
    }

    /**
     * Stream tokens from the model
     */
    async *stream(prompt, options = {}) {
        if (!this.isReady) {
            throw new ModelError('Model not loaded. Call load() first.');
        }

        const config = { ...this.modelConfig, ...options };
        const cliPath = this.getCliPath();

        const args = [
            '-m', config.path,
            '-p', prompt,
            '-n', String(config.maxTokens || 128),
            '-t', String(config.threads),
            '-c', String(config.contextSize),
            '--temp', String(config.temperature),
            '-ngl', String(config.gpuLayers),
            '-b', '1',
            '--stream'  // Enable streaming
        ];

        if (config.conversation) {
            args.push('-cnv');
        }

        const inferenceProcess = spawn(cliPath, args);
        
        for await (const chunk of inferenceProcess.stdout) {
            const text = chunk.toString();
            const tokens = this.parseStreamChunk(text);
            if (tokens) {
                yield tokens;
            }
        }
    }

    /**
     * Parse output from llama-cli
     */
    parseOutput(output) {
        // Remove system messages and extract generated text
        const lines = output.split('\n');
        const startIdx = lines.findIndex(line => line.includes('system_info'));
        const endIdx = lines.findIndex(line => line.includes('timings:'));
        
        if (startIdx !== -1 &amp;&amp; endIdx !== -1) {
            return lines.slice(startIdx + 1, endIdx).join('\n').trim();
        }
        
        // Fallback: return cleaned output
        return output
            .replace(/^.*system_info.*$/gm, '')
            .replace(/^.*timings:.*$/gm, '')
            .replace(/^.*llama_.*$/gm, '')
            .trim();
    }

    /**
     * Parse streaming chunk
     */
    parseStreamChunk(chunk) {
        // Extract tokens from streaming output
        const cleaned = chunk
            .replace(/\x1b\[[0-9;]*m/g, '') // Remove ANSI codes
            .trim();
        
        return cleaned || null;
    }

    /**
     * Unload the model and clean up resources
     */
    async unload() {
        if (this.process) {
            this.process.kill();
            this.process = null;
        }
        this.isReady = false;
        logger.info('BitNet model unloaded');
    }

    /**
     * Get model information
     */
    async getModelInfo() {
        if (!this.isReady) {
            throw new ModelError('Model not loaded');
        }

        return {
            type: 'bitnet',
            format: 'gguf',
            quantization: '1.58-bit',
            path: this.modelConfig.path,
            config: this.modelConfig
        };
    }

    /**
     * List available BitNet models
     */
    static async listAvailableModels() {
        return {
            official: [
                'microsoft/BitNet-b1.58-2B-4T'
            ],
            community: [
                '1bitLLM/bitnet_b1_58-large',
                '1bitLLM/bitnet_b1_58-3B',
                'HF1BitLLM/Llama3-8B-1.58-100B-tokens',
                'tiiuae/Falcon3-7B-Instruct-1.58bit',
                'tiiuae/Falcon3-10B-Instruct-1.58bit',
                'tiiuae/Falcon3-3B-Instruct-1.58bit',
                'tiiuae/Falcon3-1B-Instruct-1.58bit'
            ]
        };
    }
}

export default BitNetLoader;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="ABTestingManager.html">ABTestingManager</a></li><li><a href="APILoader.html">APILoader</a></li><li><a href="AnthropicAdapter.html">AnthropicAdapter</a></li><li><a href="AuditLogger.html">AuditLogger</a></li><li><a href="AuthManager.html">AuthManager</a></li><li><a href="AuthMiddleware.html">AuthMiddleware</a></li><li><a href="AzureOpenAIAdapter.html">AzureOpenAIAdapter</a></li><li><a href="BPETokenizer.html">BPETokenizer</a></li><li><a href="BaseEngine.html">BaseEngine</a></li><li><a href="BaseLoader.html">BaseLoader</a></li><li><a href="BedrockAdapter.html">BedrockAdapter</a></li><li><a href="BinaryLoader.html">BinaryLoader</a></li><li><a href="BinaryModel.html">BinaryModel</a></li><li><a href="BitNetLoader.html">BitNetLoader</a></li><li><a href="CohereAdapter.html">CohereAdapter</a></li><li><a href="ConversionConfig.html">ConversionConfig</a></li><li><a href="ConversionResult.html">ConversionResult</a></li><li><a href="DeepSeekAdapter.html">DeepSeekAdapter</a></li><li><a href="EnterpriseAuthManager.html">EnterpriseAuthManager</a></li><li><a href="EnterpriseManager.html">EnterpriseManager</a></li><li><a href="EnterpriseRouter.html">EnterpriseRouter</a></li><li><a href="ErrorHandler.html">ErrorHandler</a></li><li><a href="FireworksAdapter.html">FireworksAdapter</a></li><li><a href="FormatConverter.html">FormatConverter</a></li><li><a href="GGUFLoader.html">GGUFLoader</a></li><li><a href="GGUFModel.html">GGUFModel</a></li><li><a href="GRPCClient.html">GRPCClient</a></li><li><a href="GroqAdapter.html">GroqAdapter</a></li><li><a href="LLMRouter.html">LLMRouter</a></li><li><a href="MistralAdapter.html">MistralAdapter</a></li><li><a href="MockLoader.html">MockLoader</a></li><li><a href="MockModel.html">MockModel</a></li><li><a href="ModelError.html">ModelError</a></li><li><a href="ModelInterface.html">ModelInterface</a></li><li><a href="ModelQuantizer.html">ModelQuantizer</a></li><li><a href="ModelRegistry.html">ModelRegistry</a></li><li><a href="ModelTemplates.html">ModelTemplates</a></li><li><a href="MultiTenancyManager.html">MultiTenancyManager</a></li><li><a href="NovitaAdapter.html">NovitaAdapter</a></li><li><a href="OpenAIAdapter.html">OpenAIAdapter</a></li><li><a href="OpenRouterAdapter.html">OpenRouterAdapter</a></li><li><a href="PerplexityAdapter.html">PerplexityAdapter</a></li><li><a href="Pipeline.html">Pipeline</a></li><li><a href="PyTorchLoader.html">PyTorchLoader</a></li><li><a href="PyTorchModel.html">PyTorchModel</a></li><li><a href="QuantizationConfig.html">QuantizationConfig</a></li><li><a href="QuantizationResult.html">QuantizationResult</a></li><li><a href="Router.html">Router</a></li><li><a href="SLAMonitor.html">SLAMonitor</a></li><li><a href="SentencePieceTokenizer.html">SentencePieceTokenizer</a></li><li><a href="SimpleLoader.html">SimpleLoader</a></li><li><a href="SimpleModel.html">SimpleModel</a></li><li><a href="TogetherAdapter.html">TogetherAdapter</a></li><li><a href="TokenizationResult.html">TokenizationResult</a></li><li><a href="TokenizerConfig.html">TokenizerConfig</a></li><li><a href="UniversalTokenizer.html">UniversalTokenizer</a></li><li><a href="ValidationConfig.html">ValidationConfig</a></li><li><a href="ValidationSuite.html">ValidationSuite</a></li><li><a href="ValidationSuiteResult.html">ValidationSuiteResult</a></li><li><a href="ValidationTestResult.html">ValidationTestResult</a></li><li><a href="VertexAIAdapter.html">VertexAIAdapter</a></li><li><a href="WordPieceTokenizer.html">WordPieceTokenizer</a></li></ul><h3>Global</h3><ul><li><a href="global.html#ADAPTER_REGISTRY">ADAPTER_REGISTRY</a></li><li><a href="global.html#API_KEY_PATTERNS">API_KEY_PATTERNS</a></li><li><a href="global.html#AUTH_TYPES">AUTH_TYPES</a></li><li><a href="global.html#AZURE_API_VERSIONS">AZURE_API_VERSIONS</a></li><li><a href="global.html#AZURE_OPENAI_MODELS">AZURE_OPENAI_MODELS</a></li><li><a href="global.html#Architectures">Architectures</a></li><li><a href="global.html#AuditEventTypes">AuditEventTypes</a></li><li><a href="global.html#AuthMethods">AuthMethods</a></li><li><a href="global.html#BEDROCK_MODELS">BEDROCK_MODELS</a></li><li><a href="global.html#BreachSeverity">BreachSeverity</a></li><li><a href="global.html#CLAUDE_MODELS">CLAUDE_MODELS</a></li><li><a href="global.html#COHERE_MODELS">COHERE_MODELS</a></li><li><a href="global.html#COMPLIANCE_FEATURES">COMPLIANCE_FEATURES</a></li><li><a href="global.html#Capabilities">Capabilities</a></li><li><a href="global.html#ComplianceFrameworks">ComplianceFrameworks</a></li><li><a href="global.html#DEEPSEEK_ENDPOINTS">DEEPSEEK_ENDPOINTS</a></li><li><a href="global.html#DEEPSEEK_MODELS">DEEPSEEK_MODELS</a></li><li><a href="global.html#EnterpriseFeatures">EnterpriseFeatures</a></li><li><a href="global.html#ExperimentStatus">ExperimentStatus</a></li><li><a href="global.html#FIREWORKS_MODELS">FIREWORKS_MODELS</a></li><li><a href="global.html#GROQ_MODELS">GROQ_MODELS</a></li><li><a href="global.html#INPUT_TYPES">INPUT_TYPES</a></li><li><a href="global.html#IsolationLevels">IsolationLevels</a></li><li><a href="global.html#MISTRAL_MODELS">MISTRAL_MODELS</a></li><li><a href="global.html#MODEL_CATEGORIES">MODEL_CATEGORIES</a></li><li><a href="global.html#ModelFormat">ModelFormat</a></li><li><a href="global.html#ModelFormats">ModelFormats</a></li><li><a href="global.html#NOVITA_ENDPOINTS">NOVITA_ENDPOINTS</a></li><li><a href="global.html#NOVITA_MODELS">NOVITA_MODELS</a></li><li><a href="global.html#OPENAI_MODELS">OPENAI_MODELS</a></li><li><a href="global.html#PERPLEXITY_MODELS">PERPLEXITY_MODELS</a></li><li><a href="global.html#POPULAR_MODELS">POPULAR_MODELS</a></li><li><a href="global.html#PROVIDER_AUTH_CONFIG">PROVIDER_AUTH_CONFIG</a></li><li><a href="global.html#PROVIDER_CATEGORIES">PROVIDER_CATEGORIES</a></li><li><a href="global.html#PROVIDER_CONFIGS">PROVIDER_CONFIGS</a></li><li><a href="global.html#PROVIDER_FEATURES">PROVIDER_FEATURES</a></li><li><a href="global.html#Permissions">Permissions</a></li><li><a href="global.html#QuantizationMethod">QuantizationMethod</a></li><li><a href="global.html#QuantizationPrecision">QuantizationPrecision</a></li><li><a href="global.html#QuotaTypes">QuotaTypes</a></li><li><a href="global.html#RiskLevels">RiskLevels</a></li><li><a href="global.html#RoutingStrategies">RoutingStrategies</a></li><li><a href="global.html#SAFETY_LEVELS">SAFETY_LEVELS</a></li><li><a href="global.html#SLAMetricTypes">SLAMetricTypes</a></li><li><a href="global.html#SLAStatus">SLAStatus</a></li><li><a href="global.html#SessionTypes">SessionTypes</a></li><li><a href="global.html#SplittingAlgorithms">SplittingAlgorithms</a></li><li><a href="global.html#StatisticalTests">StatisticalTests</a></li><li><a href="global.html#TOGETHER_MODELS">TOGETHER_MODELS</a></li><li><a href="global.html#TimeWindows">TimeWindows</a></li><li><a href="global.html#TokenizerType">TokenizerType</a></li><li><a href="global.html#UserRoles">UserRoles</a></li><li><a href="global.html#VERTEX_AI_MODELS">VERTEX_AI_MODELS</a></li><li><a href="global.html#VERTEX_REGIONS">VERTEX_REGIONS</a></li><li><a href="global.html#ValidationSeverity">ValidationSeverity</a></li><li><a href="global.html#ValidationTestType">ValidationTestType</a></li><li><a href="global.html#adjustTimeouts">adjustTimeouts</a></li><li><a href="global.html#attemptRecovery">attemptRecovery</a></li><li><a href="global.html#checkConnectivity">checkConnectivity</a></li><li><a href="global.html#clearCache">clearCache</a></li><li><a href="global.html#colors">colors</a></li><li><a href="global.html#createAdapter">createAdapter</a></li><li><a href="global.html#createEnterpriseExpressRoutes">createEnterpriseExpressRoutes</a></li><li><a href="global.html#createEnterpriseRouter">createEnterpriseRouter</a></li><li><a href="global.html#createEnterpriseWebSocketHandlers">createEnterpriseWebSocketHandlers</a></li><li><a href="global.html#createMissingResources">createMissingResources</a></li><li><a href="global.html#defaultEnterpriseConfig">defaultEnterpriseConfig</a></li><li><a href="global.html#emergencyShutdown">emergencyShutdown</a></li><li><a href="global.html#enterpriseVersion">enterpriseVersion</a></li><li><a href="global.html#errorMonitoringMiddleware">errorMonitoringMiddleware</a></li><li><a href="global.html#escalateError">escalateError</a></li><li><a href="global.html#executeRecovery">executeRecovery</a></li><li><a href="global.html#getAdapter">getAdapter</a></li><li><a href="global.html#getEnabledFeatures">getEnabledFeatures</a></li><li><a href="global.html#getMonitoringStatus">getMonitoringStatus</a></li><li><a href="global.html#getProviderAuthType">getProviderAuthType</a></li><li><a href="global.html#getProviderInfo">getProviderInfo</a></li><li><a href="global.html#getProvidersByCategory">getProvidersByCategory</a></li><li><a href="global.html#getProvidersByFeature">getProvidersByFeature</a></li><li><a href="global.html#getStats">getStats</a></li><li><a href="global.html#getSupportedProviders">getSupportedProviders</a></li><li><a href="global.html#gracefulShutdown">gracefulShutdown</a></li><li><a href="global.html#handleCriticalError">handleCriticalError</a></li><li><a href="global.html#handleMemoryLeak">handleMemoryLeak</a></li><li><a href="global.html#httpMonitoringMiddleware">httpMonitoringMiddleware</a></li><li><a href="global.html#isFeatureEnabled">isFeatureEnabled</a></li><li><a href="global.html#isProviderSupported">isProviderSupported</a></li><li><a href="global.html#logError">logError</a></li><li><a href="global.html#performHealthCheck">performHealthCheck</a></li><li><a href="global.html#recordCustomMetric">recordCustomMetric</a></li><li><a href="global.html#registerAlertRule">registerAlertRule</a></li><li><a href="global.html#registerDependency">registerDependency</a></li><li><a href="global.html#registerHealthCheck">registerHealthCheck</a></li><li><a href="global.html#reinstallDependencies">reinstallDependencies</a></li><li><a href="global.html#reload">reload</a></li><li><a href="global.html#restartProcess">restartProcess</a></li><li><a href="global.html#retryConnection">retryConnection</a></li><li><a href="global.html#selectRecoveryStrategy">selectRecoveryStrategy</a></li><li><a href="global.html#setupHandlers">setupHandlers</a></li><li><a href="global.html#setupMonitoring">setupMonitoring</a></li><li><a href="global.html#softRestart">softRestart</a></li><li><a href="global.html#startHealthMonitoring">startHealthMonitoring</a></li><li><a href="global.html#startPerformanceProfile">startPerformanceProfile</a></li><li><a href="global.html#validateEnterpriseConfig">validateEnterpriseConfig</a></li><li><a href="global.html#withCacheMonitoring">withCacheMonitoring</a></li><li><a href="global.html#withDatabaseMonitoring">withDatabaseMonitoring</a></li><li><a href="global.html#withModelMonitoring">withModelMonitoring</a></li><li><a href="global.html#withQueueMonitoring">withQueueMonitoring</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Wed Aug 20 2025 19:41:21 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
